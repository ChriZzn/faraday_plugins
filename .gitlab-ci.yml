stages:
  - pre_testing
  - testing
  - post_testing
  - publish

before_script:
  - apt-get update -qy
  - pip install pip -U

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - when: always

flake8:
    image: python:3
    stage: pre_testing
    before_script:
      - pip install flake8
      # Help flake8 to find the Python files without .py extension.
      - find . -name '*.py' >> files.txt
      - sort -u files.txt | tee files.processed
    script:
        - python -m flake8 --statistics --count $(cat files.processed) --verbose
    after_script:
        - wc -l files.processed

tests:
    image: python:3.7
    stage: testing
    coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+%)/'
    before_script:
      - pip3 install virtualenv
      - virtualenv -p python3 faraday_venv
      - source faraday_venv/bin/activate
      - pip3 install pytest pytest-xdist pytest-cov Flask-Restless==0.17.0
      - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/faradaysec/faraday.git
      - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/faradaysec/support/report-collection.git
      - cd faraday
      - python3 setup.py install
      - pip uninstall faraday-plugins -y # we need to install fardaysec for marshmallow schemas, we remove plugins from pypi
      - cd ..
    script:
      - source faraday_venv/bin/activate
      - python3 setup.py install
      - pytest tests --capture=sys -v --cov=faraday_plugins --color=yes --disable-warnings


test_performance:
    image: python:3.7
    stage: post_testing
    coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+%)/'
    allow_failure: true
    before_script:
      - pip3 install virtualenv
      - virtualenv -p python3 faraday_venv
      - source faraday_venv/bin/activate
      - pip3 install pytest pytest-xdist pytest-cov
      - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/faradaysec/faraday.git
      - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/faradaysec/support/report-collection.git
      - cd faraday
      - python3 setup.py install
      - pip uninstall faraday-plugins -y # we need to install fardaysec for marshmallow schemas, we remove plugins from pypi
      - cd ..
    script:
      - source faraday_venv/bin/activate
      - python3 setup.py install
      - pytest tests --capture=sys -v --cov=faraday_plugins --color=yes --disable-warnings --performance
    rules:
      - if: '$CI_COMMIT_BRANCH == "develop"'
        when: on_success

publish_pypi:
    image: python:3
    stage: publish
    script:
      - apt-get update -qy
      - apt-get install twine -y
      - python setup.py sdist bdist_wheel
      - twine upload -u $PYPI_USER -p $PYPI_PASS dist/* --verbose
    rules:
      - if: '$CI_COMMIT_TAG'
        when: on_success

